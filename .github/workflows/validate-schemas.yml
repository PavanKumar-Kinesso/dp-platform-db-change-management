name: Validate Schemas

on:
  pull_request:
    paths:
      - 'schemas/**'
      - 'scripts/**'
      - 'requirements.txt'
  workflow_dispatch:

env:
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
  SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
  SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        schema: [Monitoring, ReportingApps, DATA_AMS]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate schema files
      run: |
        echo "Validating ${{ matrix.schema }} schema..."
        python scripts/apply_schema.py \
          --target DEV \
          --schema-folder ${{ matrix.schema }} \
          --dry-run \
          --db-prefix TEST
    
    - name: Run schema comparison
      run: |
        echo "Comparing ${{ matrix.schema }} schema with target..."
        python scripts/compare_schema.py \
          --target-env DEV \
          --schema ${{ matrix.schema }} \
          --db-prefix TEST \
        || echo "Comparison completed"
